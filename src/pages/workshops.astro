---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ClassCard from '../components/ClassCard.astro';

export const prerender = false; // This page must be server-rendered

// Fetch workshops data server-side
let workshops = [];
let error = null;

try {
	const { default: squarePkg } = await import('square');

	const client = new squarePkg.SquareClient({
		token: import.meta.env.SQUARE_ACCESS_TOKEN,
		environment: import.meta.env.SQUARE_ENVIRONMENT === 'production'
			? squarePkg.SquareEnvironment.Production
			: squarePkg.SquareEnvironment.Sandbox,
	});

	const apiResponse = await client.catalog.list(undefined, 'ITEM');
	const items = apiResponse.result?.objects || apiResponse.response?.objects || apiResponse.data || [];

	if (items && items.length > 0) {
		// Find the Workshop category ID
		const workshopCategory = items.find(item =>
			item.type === 'CATEGORY' &&
			item.categoryData?.name === 'Workshop'
		);
		const workshopCategoryId = workshopCategory?.id;

		// Filter for workshops with Workshop category
		workshops = items
			.filter(item => {
				if (item.type !== 'ITEM') return false;
				const categories = item.itemData?.categories || [];
				return categories.some(cat => cat.id === workshopCategoryId);
			})
			.map(item => {
				const itemData = item.itemData;
				const variation = itemData?.variations?.[0];
				const amountInCents = variation?.itemVariationData?.priceMoney?.amount;
				const price = amountInCents ? (Number(amountInCents) / 100).toFixed(2) : '0.00';

				return {
					id: item.id,
					name: itemData?.name || 'Unnamed Workshop',
					description: itemData?.description || '',
					price: price,
					currency: variation?.itemVariationData?.priceMoney?.currency || 'USD',
					imageUrl: itemData?.imageIds?.[0]
						? `https://items-images-production.s3.us-west-2.amazonaws.com/files/${itemData.imageIds[0]}/original.jpeg`
						: null,
				};
			});
	}
} catch (e) {
	console.error('Error fetching workshops:', e);
	error = e instanceof Error ? e.message : 'Unknown error';
}
---

<Layout
	title="Current Workshops - Homegrown Studio"
	description="Browse our current craft workshops. Book your spot today!"
>
	<Header />

	<main>
		<!-- Hero Section -->
		<section class="page-hero">
			<div class="container">
				<h1>Current Workshops</h1>
				<p class="subtitle">Explore our upcoming craft workshops</p>
			</div>
		</section>


		<!-- Workshops Grid -->
		<section class="workshops-section">
			<div class="container">
				{error ? (
					<div class="error">
						<p>Failed to load workshops. Please try again later.</p>
					</div>
				) : workshops.length > 0 ? (
					<div class="workshops-grid">
						{workshops.map((workshop, index) => (
							<ClassCard
								id={workshop.id}
								name={workshop.name}
								description={workshop.description}
								price={workshop.price}
								currency={workshop.currency}
								imageUrl={workshop.imageUrl}
								index={index}
							/>
						))}
					</div>
				) : (
					<div class="no-workshops">
						<p>No workshops available at the moment. Check back soon!</p>
					</div>
				)}
			</div>
		</section>
	</main>

	<Footer />
</Layout>

<style>
	.page-hero {
		background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
		color: white;
		padding: var(--spacing-xl) 0;
		text-align: center;
	}

	.page-hero h1 {
		font-size: 3rem;
		margin-bottom: var(--spacing-sm);
		color: white;
	}

	.subtitle {
		font-size: 1.5rem;
		opacity: 0.95;
	}

	.workshops-section {
		padding: var(--spacing-xl) 0;
		min-height: 400px;
	}

	.error {
		text-align: center;
		padding: var(--spacing-xl);
		color: #dc2626;
	}

	.workshops-grid {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
		max-width: 1200px;
		margin: 0 auto;
	}

	.class-card {
		display: flex;
		background: white;
		border-radius: 1rem;
		overflow: hidden;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		border: 1px solid #e5e7eb;
		animation: slideInFromTop 0.6s ease-out backwards;
		height: 280px;
	}

	@keyframes slideInFromTop {
		from {
			opacity: 0;
			transform: translateY(-20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.class-card:hover {
		box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
		transform: translateY(-2px);
		border-color: var(--color-primary);
	}

	.card-image {
		flex: 0 0 360px;
		position: relative;
		overflow: hidden;
	}

	.card-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.3s ease;
	}

	.class-card:hover .card-image img {
		transform: scale(1.05);
	}

	.image-placeholder {
		width: 100%;
		height: 100%;
		background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.placeholder-icon {
		font-size: 5rem;
		filter: brightness(1.2);
	}

	.card-content {
		flex: 1;
		display: flex;
		flex-direction: column;
		padding: 2rem;
		min-width: 0;
	}

	.card-body {
		flex: 1;
		min-height: 0;
	}

	.card-title {
		font-size: 1.75rem;
		font-weight: 700;
		color: var(--color-text);
		margin: 0 0 1rem 0;
		line-height: 1.2;
	}

	.card-description {
		font-size: 1rem;
		color: var(--color-text-light);
		line-height: 1.6;
		margin: 0;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.card-footer {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1.5rem;
		padding-top: 1.5rem;
		margin-top: 1.5rem;
		border-top: 1px solid #e5e7eb;
	}

	.price-section {
		display: flex;
		align-items: baseline;
		gap: 0.5rem;
	}

	.price {
		font-size: 2rem;
		font-weight: 700;
		color: var(--color-primary);
		line-height: 1;
	}

	.currency {
		font-size: 0.875rem;
		color: var(--color-text-light);
		font-weight: 500;
	}

	.book-btn {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.875rem 1.75rem;
		background: var(--color-primary);
		color: white;
		border: none;
		border-radius: 0.5rem;
		font-weight: 600;
		font-size: 1rem;
		cursor: pointer;
		transition: all 0.2s ease;
		white-space: nowrap;
	}

	.book-btn:hover {
		background: var(--color-primary-dark);
		transform: translateX(2px);
	}

	.book-btn svg {
		transition: transform 0.2s ease;
	}

	.book-btn:hover svg {
		transform: translateX(4px);
	}

	.no-workshops {
		text-align: center;
		padding: var(--spacing-xl);
		color: var(--color-text-light);
		font-size: 1.125rem;
	}

	@media (max-width: 1024px) {
		.class-card {
			height: auto;
		}

		.card-image {
			flex: 0 0 280px;
		}

		.card-content {
			padding: 1.5rem;
		}

		.card-title {
			font-size: 1.5rem;
		}

		.price {
			font-size: 1.75rem;
		}
	}

	@media (max-width: 768px) {
		.page-hero h1 {
			font-size: 2rem;
		}

		.subtitle {
			font-size: 1.125rem;
		}

		.class-card {
			flex-direction: column;
			height: auto;
		}

		.card-image {
			flex: 0 0 240px;
			width: 100%;
		}

		.card-content {
			padding: 1.5rem;
		}

		.card-description {
			-webkit-line-clamp: 4;
		}

		.card-footer {
			flex-direction: column;
			align-items: stretch;
			gap: 1rem;
		}

		.price-section {
			justify-content: center;
		}

		.book-btn {
			width: 100%;
			justify-content: center;
		}
	}
</style>

<script>
	// Add click handlers for book buttons
	document.addEventListener('DOMContentLoaded', () => {
		document.querySelectorAll('.book-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const target = e.target as HTMLElement;
				const workshopId = target.dataset.workshopId;
				window.location.href = `/booking?workshop=${workshopId}`;
			});
		});
	});
</script>
