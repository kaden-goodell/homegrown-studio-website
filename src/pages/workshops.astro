---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ClassCard from '../components/ClassCard.astro';

export const prerender = false; // This page must be server-rendered

// Fetch workshops data server-side
let workshops = [];
let error = null;

try {
	const { default: squarePkg } = await import('square');

	const client = new squarePkg.SquareClient({
		token: import.meta.env.SQUARE_ACCESS_TOKEN,
		environment: import.meta.env.SQUARE_ENVIRONMENT === 'production'
			? squarePkg.SquareEnvironment.Production
			: squarePkg.SquareEnvironment.Sandbox,
	});

	const apiResponse = await client.catalog.list(undefined, 'ITEM');
	const items = apiResponse.result?.objects || apiResponse.response?.objects || apiResponse.data || [];

	if (items && items.length > 0) {
		// Find the Workshop category ID
		const workshopCategory = items.find(item =>
			item.type === 'CATEGORY' &&
			item.categoryData?.name === 'Workshop'
		);
		const workshopCategoryId = workshopCategory?.id;

		// Filter for workshops with Workshop category
		workshops = items
			.filter(item => {
				if (item.type !== 'ITEM') return false;
				const categories = item.itemData?.categories || [];
				return categories.some(cat => cat.id === workshopCategoryId);
			})
			.map(item => {
				const itemData = item.itemData;
				const variation = itemData?.variations?.[0];
				const amountInCents = variation?.itemVariationData?.priceMoney?.amount;
				const price = amountInCents ? (Number(amountInCents) / 100).toFixed(2) : '0.00';

				return {
					id: item.id,
					name: itemData?.name || 'Unnamed Workshop',
					description: itemData?.description || '',
					price: price,
					currency: variation?.itemVariationData?.priceMoney?.currency || 'USD',
					imageUrl: itemData?.imageIds?.[0]
						? `https://items-images-production.s3.us-west-2.amazonaws.com/files/${itemData.imageIds[0]}/original.jpeg`
						: null,
				};
			});
	}
} catch (e) {
	console.error('Error fetching workshops:', e);
	error = e instanceof Error ? e.message : 'Unknown error';
}
---

<Layout
	title="Current Workshops - Homegrown Studio"
	description="Browse our current craft workshops. Book your spot today!"
>
	<Header />

	<main class="min-h-screen bg-base-200">
		<!-- Hero Section -->
		<section class="bg-gradient-to-r from-primary to-secondary text-primary-content py-16 lg:py-24">
			<div class="container mx-auto px-4">
				<h1 class="text-5xl lg:text-6xl font-bold mb-4 text-center">Current Workshops</h1>
				<p class="text-xl lg:text-2xl text-center opacity-95">Explore our upcoming craft workshops</p>
			</div>
		</section>

		<!-- Workshops Grid -->
		<section class="py-12 lg:py-16">
			<div class="container mx-auto px-4">
				{error ? (
					<div class="alert alert-error">
						<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
						<span>Failed to load workshops. Please try again later.</span>
					</div>
				) : workshops.length > 0 ? (
					<div class="flex flex-col gap-6 max-w-6xl mx-auto">
						{workshops.map((workshop, index) => (
							<ClassCard
								id={workshop.id}
								name={workshop.name}
								description={workshop.description}
								price={workshop.price}
								currency={workshop.currency}
								imageUrl={workshop.imageUrl}
								index={index}
							/>
						))}
					</div>
				) : (
					<div class="text-center py-16">
						<p class="text-xl text-base-content/70">No workshops available at the moment. Check back soon!</p>
					</div>
				)}
			</div>
		</section>
	</main>

	<Footer />
</Layout>

<script>
	// Add click handlers for book buttons
	document.addEventListener('DOMContentLoaded', () => {
		document.querySelectorAll('.btn-primary').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const target = e.target as HTMLElement;
				const workshopId = target.dataset.workshopId || target.closest('[data-workshop-id]')?.getAttribute('data-workshop-id');
				if (workshopId) {
					window.location.href = `/booking?workshop=${workshopId}`;
				}
			});
		});
	});
</script>
